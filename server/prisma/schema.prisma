// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== ENUMS ==============

enum UserRole {
  ADMIN
  VENDEDOR
  ASISTENTE
}

enum VehicleStatus {
  DISPONIBLE
  RESERVADO
  VENDIDO
  MANTENIMIENTO
}

enum SaleStage {
  INTERESADO
  PRUEBA
  NEGOCIACION
  VENDIDO
  CANCELADO
}

enum TenantStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum SubscriptionPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============== MULTI-TENANCY MODELS ==============

model Tenant {
  id          String           @id @default(cuid())
  name        String
  subdomain   String           @unique
  status      TenantStatus     @default(PENDING)
  plan        SubscriptionPlan @default(FREE)
  email       String
  phone       String?
  maxUsers    Int              @default(5)
  maxVehicles Int              @default(100)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  approvedAt  DateTime?

  // Relations to all tenant-scoped models
  users                 User[]
  appConfig             AppConfig?
  vehicles              Vehicle[]
  clients               Client[]
  sales                 Sale[]
  testDrives            TestDrive[]
  notifications         Notification[]
  documentTemplates     DocumentTemplate[]
  paymentMethods        PaymentMethod[]
  vehiclePropertyFields VehiclePropertyField[]

  @@map("tenants")
}

model SuperAdmin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("super_admins")
}

model TenantRegistration {
  id              String             @id @default(cuid())
  companyName     String
  subdomain       String             @unique
  email           String
  phone           String?
  password        String             // Hashed password for the admin user
  userName        String
  status          RegistrationStatus @default(PENDING)
  rejectionReason String?
  createdAt       DateTime           @default(now())
  reviewedAt      DateTime?

  @@map("tenant_registrations")
}

// ============== USER MODEL ==============

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(ASISTENTE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Tenant relation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  sales           Sale[]
  testDrives      TestDrive[]
  notifications   Notification[]
  createdVehicles Vehicle[]      @relation("VehicleCreator")
  createdClients  Client[]       @relation("ClientCreator")

  @@index([tenantId])
  @@map("users")
}

// ============== VEHICLE MODELS ==============

model Vehicle {
  id          String        @id @default(cuid())
  marca       String
  modelo      String
  ano         Int
  precio      Float
  moneda      String        @default("USD")
  kilometraje Int
  estado      VehicleStatus @default(DISPONIBLE)
  descripcion String?
  imagen      String?
  imagenes    String[]      @default([])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdById String
  createdBy   User          @relation("VehicleCreator", fields: [createdById], references: [id])

  // Tenant relation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  sales      Sale[]
  testDrives TestDrive[]
  documents  VehicleDocument[]
  properties VehicleProperty[]

  @@index([tenantId])
  @@map("vehicles")
}

model VehiclePropertyField {
  id            String   @id @default(cuid())
  nombre        String
  tipo          String   @default("TEXT")
  esPredefinida Boolean  @default(false)
  orden         Int      @default(0)
  activa        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Tenant relation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  values VehicleProperty[]

  @@unique([tenantId, nombre, esPredefinida])
  @@index([tenantId])
  @@map("vehicle_property_fields")
}

model VehicleProperty {
  id        String   @id @default(cuid())
  valor     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  fieldId String
  field   VehiclePropertyField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([vehicleId, fieldId])
  @@map("vehicle_properties")
}

model VehicleDocument {
  id               String    @id @default(cuid())
  nombre           String
  tipo             String
  archivo          String
  contenido        String?   @db.Text
  mimetype         String?
  descripcion      String?
  fechaVencimiento DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@map("vehicle_documents")
}

// ============== CLIENT MODEL ==============

model Client {
  id          String   @id @default(cuid())
  nombre      String
  email       String?
  telefono    String
  direccion   String?
  interes     String?
  notas       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String
  createdBy   User     @relation("ClientCreator", fields: [createdById], references: [id])

  // Tenant relation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  sales      Sale[]
  testDrives TestDrive[]

  @@index([tenantId])
  @@map("clients")
}

// ============== SALE MODELS ==============

model Sale {
  id          String    @id @default(cuid())
  etapa       SaleStage @default(INTERESADO)
  precioFinal Float?
  notas       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  vendedorId String
  vendedor   User   @relation(fields: [vendedorId], references: [id])

  // Tenant relation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  paymentMethods SalePaymentMethod[]
  documents      SaleDocument[]

  @@index([tenantId])
  @@map("sales")
}

model SalePaymentMethod {
  id        String   @id @default(cuid())
  monto     Float?
  notas     String?
  createdAt DateTime @default(now())

  saleId String
  sale   Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  paymentMethodId String
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id])

  documents SaleDocument[]

  @@map("sale_payment_methods")
}

model SaleDocument {
  id          String   @id @default(cuid())
  nombre      String
  tipo        String   // CONTRATO, COMPROBANTE_PAGO, ENTREGA, IDENTIFICACION, OTRO
  categoria   String?  // For grouping: contrato, pago, entrega, identificacion
  archivo     String
  contenido   String?  @db.Text
  mimetype    String?
  descripcion String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  saleId String
  sale   Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  // Optional link to specific payment method (for payment proofs)
  salePaymentMethodId String?
  salePaymentMethod   SalePaymentMethod? @relation(fields: [salePaymentMethodId], references: [id], onDelete: SetNull)

  @@map("sale_documents")
}

// ============== TEST DRIVE MODEL ==============

model TestDrive {
  id        String   @id @default(cuid())
  fecha     DateTime
  hora      String
  notas     String?
  estado    String   @default("PENDIENTE")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  vendedorId String
  vendedor   User   @relation(fields: [vendedorId], references: [id])

  // Tenant relation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("test_drives")
}

// ============== NOTIFICATION MODEL ==============

model Notification {
  id        String   @id @default(cuid())
  titulo    String
  mensaje   String
  leida     Boolean  @default(false)
  tipo      String
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Tenant relation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("notifications")
}

// ============== DOCUMENT TEMPLATE MODEL ==============

model DocumentTemplate {
  id          String   @id @default(cuid())
  nombre      String
  contenido   String
  descripcion String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Tenant relation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("document_templates")
}

// ============== PAYMENT METHOD MODELS ==============

model PaymentMethod {
  id          String   @id @default(cuid())
  nombre      String
  descripcion String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Tenant relation
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  documents    PaymentDocument[]
  salePayments SalePaymentMethod[]

  @@index([tenantId])
  @@map("payment_methods")
}

model PaymentDocument {
  id          String   @id @default(cuid())
  nombre      String
  archivo     String
  contenido   String?  @db.Text
  mimetype    String?
  descripcion String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  paymentMethodId String
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id], onDelete: Cascade)

  @@map("payment_documents")
}

// ============== APP CONFIG MODEL ==============

model AppConfig {
  id              String   @id @default(cuid())
  nombreEmpresa   String   @default("AutoCRM")
  colorPrimario   String   @default("#3b82f6")
  colorSecundario String   @default("#1e40af")
  logo            String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Tenant relation (one config per tenant)
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("app_config")
}
